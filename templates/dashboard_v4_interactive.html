<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetHospital KPI - Dashboard Interactivo</title>

    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Auth Module -->
    <script src="/static/auth.js"></script>

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-sidebar: #1f2937;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-sidebar: #0f1419;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .sidebar {
            background: linear-gradient(180deg, var(--bg-sidebar) 0%, #0f172a 100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-item {
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-color);
        }

        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-left-color: var(--accent-color);
            font-weight: 600;
        }

        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .metric-card {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover));
            color: white;
            border: none;
        }

        .loading-spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            min-height: 400px;
            position: relative;
        }

        .period-selector {
            display: inline-flex;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 4px;
        }

        .period-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .period-btn:hover {
            color: var(--text-primary);
        }

        .period-btn.active {
            background-color: var(--accent-color);
            color: white;
        }

        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .export-dropdown {
            position: relative;
            display: inline-block;
        }

        .export-menu {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            z-index: 100;
        }

        .export-menu.show {
            display: block;
        }

        .export-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .export-item:hover {
            background-color: var(--bg-secondary);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 1rem;
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.positive {
            background-color: #dcfce7;
            color: #166534;
        }

        .stat-badge.negative {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .stat-badge.neutral {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        [data-theme="dark"] .stat-badge.positive {
            background-color: #14532d;
            color: #86efac;
        }

        [data-theme="dark"] .stat-badge.negative {
            background-color: #7f1d1d;
            color: #fca5a5;
        }

        [data-theme="dark"] .stat-badge.neutral {
            background-color: #312e81;
            color: #a5b4fc;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
        <i class="fas fa-moon" id="theme-icon"></i>
    </button>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar w-64 flex-shrink-0 overflow-y-auto">
            <div class="p-6">
                <h1 class="text-white text-2xl font-bold flex items-center gap-2">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </h1>
                <p class="text-gray-400 text-sm mt-1">Dashboard Interactivo</p>
            </div>

            <!-- User Info -->
            <div class="px-6 pb-4">
                <div class="bg-white/10 rounded-lg p-3 border border-white/10">
                    <div class="flex items-center gap-2 text-white mb-2">
                        <i class="fas fa-user-circle text-xl"></i>
                        <div class="flex-1">
                            <p class="text-sm font-semibold" id="user-name">Cargando...</p>
                            <p class="text-xs text-gray-400" id="user-username">@user</p>
                        </div>
                    </div>
                    <div id="user-roles" class="flex gap-1 flex-wrap mb-2">
                        <!-- Roles will be populated by JavaScript -->
                    </div>
                    <button onclick="logout()" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-300 px-3 py-2 rounded text-sm transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Cerrar Sesión
                    </button>
                </div>
            </div>

            <nav class="px-3">
                <div class="mb-6">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">General</p>
                    <a onclick="showModule('overview', event)" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-home w-5"></i>
                        <span>Resumen General</span>
                    </a>
                </div>

                <div class="mb-6">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">Centros</p>
                    <a onclick="showModule('centers-comparison', event)" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-hospital w-5"></i>
                        <span>Comparación</span>
                    </a>
                </div>

                <div class="mb-6">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">Pruebas</p>
                    <a onclick="showModule('tests-top', event)" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-flask w-5"></i>
                        <span>Top Pruebas</span>
                    </a>
                </div>

                <div class="mb-6">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">Especies</p>
                    <a onclick="showModule('species-distribution', event)" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-paw w-5"></i>
                        <span>Distribución</span>
                    </a>
                    <a onclick="showModule('breeds-top', event)" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-dog w-5"></i>
                        <span>Top Razas</span>
                    </a>
                </div>

                <!-- System Section -->
                <div class="mb-6">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">Sistema</p>
                    <a href="/settings" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-cog w-5"></i>
                        <span>Configuración</span>
                    </a>
                    <a href="/reports" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-file-alt w-5"></i>
                        <span>Reportes</span>
                    </a>
                </div>

                <!-- Admin Section (only for admins) -->
                <div id="admin-section" class="mb-6" style="display: none;">
                    <p class="text-gray-500 text-xs uppercase tracking-wider px-3 mb-2">Administración</p>
                    <a href="/admin/users" class="sidebar-item flex items-center gap-3 px-3 py-3 rounded-lg text-gray-300 cursor-pointer mb-1">
                        <i class="fas fa-users-cog w-5"></i>
                        <span>Gestión de Usuarios</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto" style="background-color: var(--bg-secondary);">
            <!-- Header -->
            <div class="bg-white dark:bg-gray-800 border-b" style="border-color: var(--border-color);">
                <div class="px-8 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="breadcrumb" id="breadcrumb">
                                <i class="fas fa-home"></i>
                                <span class="breadcrumb-separator">/</span>
                                <span id="current-module">Resumen General</span>
                            </div>
                            <h2 class="text-2xl font-bold" id="module-title">Resumen General</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Period Selector -->
                            <div class="period-selector">
                                <button class="period-btn active" onclick="changePeriod(7)">7D</button>
                                <button class="period-btn" onclick="changePeriod(30)">30D</button>
                                <button class="period-btn" onclick="changePeriod(60)">60D</button>
                                <button class="period-btn" onclick="changePeriod(90)">90D</button>
                            </div>
                            <!-- Export Button -->
                            <div class="export-dropdown">
                                <button onclick="toggleExportMenu()" class="px-4 py-2 rounded-lg border" style="background-color: var(--accent-color); color: white; border: none;">
                                    <i class="fas fa-download mr-2"></i>Exportar
                                </button>
                                <div class="export-menu" id="export-menu">
                                    <div class="export-item" onclick="exportData('csv')">
                                        <i class="fas fa-file-csv mr-2"></i>CSV
                                    </div>
                                    <div class="export-item" onclick="exportData('excel')">
                                        <i class="fas fa-file-excel mr-2"></i>Excel
                                    </div>
                                    <div class="export-item" onclick="exportData('pdf')">
                                        <i class="fas fa-file-pdf mr-2"></i>PDF
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="p-8">
                <div id="content" class="fade-in">
                    <!-- Content will be loaded here dynamically -->
                    <div class="flex items-center justify-center" style="min-height: 400px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentModule = 'overview';
        let currentPeriod = 30;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentData = null; // Store current data for exports

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').classList.remove('fa-moon');
                document.getElementById('theme-icon').classList.add('fa-sun');
            }

            // Load initial module
            showModule('overview');
        });

        // Theme toggle
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);

            const icon = document.getElementById('theme-icon');
            if (currentTheme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }

            // Reload current module to apply theme to charts
            loadCurrentModule();
        }

        // Period change
        function changePeriod(days) {
            currentPeriod = days;

            // Update active button
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload current module
            loadCurrentModule();
        }

        // Module navigation
        function showModule(module, e = null) {
            currentModule = module;

            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            // Only try to set active if event was provided
            if (e && e.target) {
                const sidebarItem = e.target.closest('.sidebar-item');
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                }
            } else {
                // If no event, find by module name
                const selector = `[onclick*="'${module}'"]`;
                const item = document.querySelector(selector);
                if (item) {
                    item.closest('.sidebar-item')?.classList.add('active');
                }
            }

            // Update breadcrumb and title
            const titles = {
                'overview': 'Resumen General',
                'centers-comparison': 'Comparación de Centros',
                'tests-top': 'Top Pruebas',
                'species-distribution': 'Distribución de Especies',
                'breeds-top': 'Top Razas'
            };

            document.getElementById('current-module').textContent = titles[module];
            document.getElementById('module-title').textContent = titles[module];

            loadCurrentModule();
        }

        function loadCurrentModule() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex items-center justify-center" style="min-height: 400px;"><div class="loading-spinner"></div></div>';
            content.classList.remove('fade-in');

            setTimeout(() => {
                const moduleMap = {
                    'overview': loadOverview,
                    'centers-comparison': loadCentersComparison,
                    'tests-top': loadTopTests,
                    'species-distribution': loadSpeciesDistribution,
                    'breeds-top': loadTopBreeds
                };

                if (moduleMap[currentModule]) {
                    moduleMap[currentModule]();
                }

                content.classList.add('fade-in');
            }, 300);
        }

        // Export functionality
        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('show');
        }

        function exportData(format) {
            toggleExportMenu();

            const exportUrls = {
                'centers-comparison': `/analytics/export/centers/comparison?format=${format}&days=${currentPeriod}`,
                'tests-top': `/analytics/export/tests/top?format=${format}&days=${currentPeriod}&limit=20`
            };

            if (exportUrls[currentModule]) {
                window.location.href = exportUrls[currentModule];
            } else {
                alert('Exportación no disponible para este módulo');
            }
        }

        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.export-dropdown');
            if (!dropdown.contains(e.target)) {
                document.getElementById('export-menu').classList.remove('show');
            }
        });

        // Plotly theme configuration
        function getPlotlyLayout(title) {
            const isDark = currentTheme === 'dark';
            return {
                title: {
                    text: title,
                    font: {
                        size: 18,
                        color: isDark ? '#f9fafb' : '#111827',
                        family: 'system-ui, -apple-system, sans-serif'
                    }
                },
                paper_bgcolor: isDark ? '#111827' : '#ffffff',
                plot_bgcolor: isDark ? '#1f2937' : '#f9fafb',
                font: {
                    color: isDark ? '#f9fafb' : '#111827'
                },
                xaxis: {
                    gridcolor: isDark ? '#374151' : '#e5e7eb',
                    color: isDark ? '#9ca3af' : '#6b7280'
                },
                yaxis: {
                    gridcolor: isDark ? '#374151' : '#e5e7eb',
                    color: isDark ? '#9ca3af' : '#6b7280'
                },
                hovermode: 'closest',
                hoverlabel: {
                    bgcolor: isDark ? '#374151' : '#ffffff',
                    font: {
                        color: isDark ? '#f9fafb' : '#111827'
                    }
                }
            };
        }

        const plotlyConfig = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['sendDataToCloud', 'lasso2d', 'select2d'],
            toImageButtonOptions: {
                format: 'png',
                filename: 'chart',
                height: 800,
                width: 1200,
                scale: 2
            }
        };

        // Module loading functions (will be implemented next)
        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat('es-ES').format(num);
        }

        function formatPercent(num) {
            return new Intl.NumberFormat('es-ES', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(num / 100);
        }

        function getGrowthBadge(growth) {
            if (growth > 0) {
                return `<span class="stat-badge positive"><i class="fas fa-arrow-up"></i>${formatPercent(growth)}</span>`;
            } else if (growth < 0) {
                return `<span class="stat-badge negative"><i class="fas fa-arrow-down"></i>${formatPercent(Math.abs(growth))}</span>`;
            } else {
                return `<span class="stat-badge neutral"><i class="fas fa-minus"></i>0%</span>`;
            }
        }

        // ========================================================================
        // AUTHENTICATION FUNCTIONS
        // ========================================================================

        /**
         * Logout function
         */
        function logout() {
            if (confirm('¿Estás seguro de que deseas cerrar sesión?')) {
                Auth.logout();
            }
        }

        /**
         * Check authentication on page load
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Check if user is authenticated
            if (!Auth.requireAuth()) {
                return;
            }

            // Get user data from localStorage and update UI
            const user = Auth.getCurrentUser();
            if (user) {
                console.log('User authenticated:', user.username);

                // Update user name and username
                const userName = document.getElementById('user-name');
                const userUsername = document.getElementById('user-username');
                if (userName) userName.textContent = user.full_name || user.username || 'Usuario';
                if (userUsername) userUsername.textContent = '@' + (user.username || 'user');

                // Display user roles
                const rolesContainer = document.getElementById('user-roles');
                if (rolesContainer && user.roles && user.roles.length > 0) {
                    rolesContainer.innerHTML = user.roles.map(role =>
                        `<span class="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded">${role}</span>`
                    ).join('');
                }

                // Show admin section if user is admin or superuser
                const isAdmin = user.is_superuser || (user.roles && user.roles.includes('admin'));
                if (isAdmin) {
                    const adminSection = document.getElementById('admin-section');
                    if (adminSection) {
                        adminSection.style.display = 'block';
                    }
                }
            }
        });
    </script>

    <!-- Module implementations will be added in next file -->
    <script src="/static/dashboard-modules.js"></script>
</body>
</html>
